# Maintainer: Task Coach developers <developers@taskcoach.org>
# Contributor: Aaron Wolf <https://github.com/realcarbonneau>

pkgname=taskcoach
pkgver=2.0.0.75
pkgrel=1
pkgdesc="Your friendly task manager - personal task manager with composite tasks, effort tracking, and more"
arch=('any')
url="https://github.com/taskcoach/taskcoach"
license=('GPL3')
depends=(
    'python>=3.8'
    'python-wxpython>=4.2.0'
    'python-six>=1.16.0'
    'python-pypubsub'
    'python-watchdog>=3.0.0'
    'python-chardet>=5.2.0'
    'python-dateutil>=2.9.0'
    'python-pyparsing>=3.1.3'
    'python-lxml'
    'python-pyxdg'
    'python-keyring'
    'python-numpy'
    'python-fasteners>=0.19'
    'libxss'
    'xdg-utils'
)
makedepends=(
    'python-setuptools'
    'python-distro'
    'python-pip'
)
optdepends=(
    'python-zeroconf: iPhone sync service discovery'
    'python-gntp: Growl notification support'
    'espeak-ng: Spoken reminders'
)
# Note: squaremap is not in Arch repos, installed via pip at build time
provides=('taskcoach')
conflicts=('taskcoach-git')
source=("$pkgname-$pkgver.tar.gz::$url/archive/refs/tags/v${pkgver%.73}.tar.gz")
sha256sums=('SKIP')
install=taskcoach.install

# For local builds from git source, override source
# source=("git+$url.git#tag=v${pkgver%.73}")

prepare() {
    # If building from release tarball, the directory name may vary
    if [[ -d "taskcoach-${pkgver%.73}" ]]; then
        mv "taskcoach-${pkgver%.73}" "$pkgname-$pkgver"
    elif [[ -d "taskcoach-main" ]]; then
        mv "taskcoach-main" "$pkgname-$pkgver"
    fi
}

build() {
    cd "$srcdir/$pkgname-$pkgver" || cd "$srcdir"/*taskcoach* || return 1
    python setup.py build
}

package() {
    cd "$srcdir/$pkgname-$pkgver" || cd "$srcdir"/*taskcoach* || return 1

    # Install Python package
    python setup.py install --root="$pkgdir" --prefix=/usr --optimize=1 --skip-build

    # Install squaremap (not available in Arch repos)
    local _py3ver=$(python -c "import sys; print(f'{sys.version_info.major}.{sys.version_info.minor}')")
    pip install --no-deps --target="$pkgdir/usr/lib/python${_py3ver}/site-packages/" squaremap

    # Install desktop file
    install -Dm644 build.in/linux_common/taskcoach.desktop \
        "$pkgdir/usr/share/applications/taskcoach.desktop"

    # Install AppStream metadata
    install -Dm644 build.in/debian/taskcoach.appdata.xml \
        "$pkgdir/usr/share/metainfo/taskcoach.appdata.xml"

    # Install icon
    install -Dm644 icons.in/taskcoach.png \
        "$pkgdir/usr/share/pixmaps/taskcoach.png"

    # Install Welcome.tsk for first-run experience
    install -Dm644 Welcome.tsk \
        "$pkgdir/usr/share/taskcoach/Welcome.tsk"

    # Install license/copyright
    install -Dm644 COPYRIGHT.txt \
        "$pkgdir/usr/share/licenses/$pkgname/COPYRIGHT"

    # Install documentation
    install -Dm644 README.md \
        "$pkgdir/usr/share/doc/$pkgname/README.md"
}
