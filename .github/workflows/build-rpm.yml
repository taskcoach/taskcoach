name: Build RPM Package

on:
  push:
    branches:
      - main
      - master
      - 'claude/**'
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-rpm:
    name: Build RPM on ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora:39
            name: Fedora 39
            os: fedora
            osver: "39"
          - distro: fedora:40
            name: Fedora 40
            os: fedora
            osver: "40"

    container:
      image: ${{ matrix.distro }}

    steps:
      - name: Install git and basic tools
        run: |
          dnf install -y git rpm-build rpmdevtools dnf-plugins-core

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install build dependencies
        run: |
          # ============================================================
          # Fedora Dependency Installation
          # Strategy: Use Fedora packages for everything available,
          #           pip only for packages not in Fedora repos.
          # See docs/PACKAGING.md for dependency availability matrix.
          # ============================================================

          # Build tools (required)
          dnf install -y \
            python3-devel \
            python3-setuptools \
            python3-pip \
            python3-distro \
            desktop-file-utils \
            libappstream-glib

          # Runtime dependencies - ALL from Fedora repos
          dnf install -y \
            python3-wxpython4 \
            python3-six \
            python3-pypubsub \
            python3-watchdog \
            python3-chardet \
            python3-dateutil \
            python3-pyparsing \
            python3-lxml \
            python3-pyxdg \
            python3-keyring \
            python3-numpy \
            python3-fasteners \
            python3-zeroconf

          # NOT in Fedora repos - install via pip during RPM build:
          # - squaremap (bundled in RPM via pip install in spec file)

      - name: Get version info
        id: version
        run: |
          VERSION=$(python3 -c "
          import sys
          sys.path.insert(0, '.')
          from taskcoachlib.meta import data
          print(data.version_full)
          ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Setup RPM build environment
        run: |
          rpmdev-setuptree

          # Copy spec file
          cp build.in/fedora/taskcoach.spec ~/rpmbuild/SPECS/

          # Update version in spec file
          VERSION="${{ steps.version.outputs.version }}"
          sed -i "s/^Version:.*/Version:        $VERSION/" ~/rpmbuild/SPECS/taskcoach.spec

          # Create source tarball
          SRCDIR="taskcoach-main"
          mkdir -p /tmp/$SRCDIR
          cp -r . /tmp/$SRCDIR/
          cd /tmp
          tar czf ~/rpmbuild/SOURCES/taskcoach-$VERSION.tar.gz $SRCDIR
          cd -

      - name: Build RPM
        run: |
          cd ~/rpmbuild/SPECS

          # Build the RPM
          # Note: --nodeps used because build deps are handled by dnf above,
          # and squaremap is bundled via pip in the spec file
          rpmbuild -bb taskcoach.spec \
            --define "_topdir $HOME/rpmbuild" \
            --nodeps

          echo "Build complete!"
          ls -la ~/rpmbuild/RPMS/noarch/

      - name: Collect artifacts
        run: |
          mkdir -p artifacts
          VERSION="${{ steps.version.outputs.version }}"
          OS="${{ matrix.os }}"
          OSVER="${{ matrix.osver }}"

          for rpm in ~/rpmbuild/RPMS/noarch/*.rpm; do
            if [ -f "$rpm" ]; then
              BASENAME=$(basename "$rpm")
              # Rename to include distro info
              NEWNAME="taskcoach-${VERSION}-${OS}${OSVER}.noarch.rpm"
              cp "$rpm" "artifacts/$NEWNAME"
              echo "Collected: $NEWNAME"
            fi
          done

          ls -la artifacts/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: taskcoach-${{ steps.version.outputs.version }}-${{ matrix.os }}-${{ matrix.osver }}
          path: artifacts/
          retention-days: 30

  test-rpm:
    name: Test RPM on ${{ matrix.name }}
    needs: build-rpm
    runs-on: ubuntu-latest
    continue-on-error: true
    strategy:
      fail-fast: false
      matrix:
        include:
          - distro: fedora:39
            name: Fedora 39
            os: fedora
            osver: "39"
          - distro: fedora:40
            name: Fedora 40
            os: fedora
            osver: "40"

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          pattern: taskcoach-*-${{ matrix.os }}-${{ matrix.osver }}
          merge-multiple: true
          path: packages

      - name: Test installation in Docker
        run: |
          RPM_FILE=$(ls packages/*.rpm 2>/dev/null | head -1)
          if [ -z "$RPM_FILE" ]; then
            echo "No RPM file found"
            ls -la packages/
            exit 1
          fi
          echo "Testing: $RPM_FILE"

          docker run --rm \
            -v "$(pwd)/packages:/packages:ro" \
            ${{ matrix.distro }} \
            bash -c '
              set -e
              dnf install -y /packages/*.rpm || {
                echo "Installing with --skip-broken due to missing optional deps..."
                dnf install -y --skip-broken /packages/*.rpm || true
              }

              # Verify installation
              echo "Checking installed files..."
              rpm -ql taskcoach | head -20

              # Check Python import works
              echo "Testing Python import..."
              python3 -c "import taskcoachlib; print(\"SUCCESS: taskcoachlib imported\")" || {
                echo "Import failed, checking if package installed..."
                rpm -q taskcoach
              }

              echo "Installation test complete!"
            '

  release:
    name: Create Release
    needs: [build-rpm, test-rpm]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: taskcoach-*
          merge-multiple: true
          path: packages

      - name: List packages
        run: ls -la packages/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: packages/*.rpm
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
